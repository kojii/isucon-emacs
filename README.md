# ベーシック社内ISUCON！ 2019/02/02

## タイムスケジュール

- 10:00 *コンテスト開幕、開幕の挨拶*
- 10:30 *競技スタート*
- 12:30 *お昼休憩 競技中断*
- 13:30 *お昼休憩終了 競技再開*
- 17:30 *競技終了*
- 18:00 *結果測定結果、表彰、コンテスト開幕、開幕の挨拶*
- 18:30 *自由に解散*


## Getting Started

はじめに以下の操作を行い、問題なく動くかを確認して下さい。

### 1. スタッフ用意したEC2インスタンスに `isucon` ユーザで SSH ログインする

例:

```
ssh -i <設定した鍵ファイル> isucon@xx.xx.xx.xx

A 54.65.65.92   # SECOM
B 52.199.19.96  # emacs
C 18.182.119.81 # なるほど名前重要
D 52.192.37.133 # 鎖威祖苦
```

rootユーザーは`admin`です。

### 2. アプリケーションの動作を確認

EC2インスタンスのパブリックIPアドレスにブラウザでアクセスし、動作を確認してください。以下の画面が表示されるはずです。

例として、「アカウント名」は `mary`、 「パスワード」は `marymary` を入力することでログインが行えます。

ブラウザでアクセスできない場合、主催者に確認してください。

### 3. 負荷走行を実行

スコアが表示されるかどうか確認してください。ベンチには約１分程かかります。

```
# ベンチマークサーバーにssh！
$ ssh -i ~/.ssh/isucon.pem admin@52.69.228.69

# ベンチマークコマンド　各種チームごとに用意してます。
$ isu_bench_a # isu_bench_b, isu_bench_c, isu_bench_d

{"pass":true,"score":1000,"success":1000,"fail":0,"messages":[]} #=> スコアのリザルト
<nil> #=> スコア通信時のエラー nilならOK
```

なお、意図してほかチームにベンチをかける行いは禁止です。

## ディレクトリ構成

実装のアプリケーションコードは `/home/isucon` ディレクトリ以下にあります。

```
/home/isucon/isucon-01/
  ├ provisioning      # アプリケーション構築用のProvisioningツール
  ├ sinatra/          # 今回の競技用アプリケーション
  ├ manual.md         # 本マニュアル
  └ advance_manual.md # 事前告知マニュアル
```



## アプリケーションコード確認用の Docker 環境構築

### Docker のビルド
sinatra ディレクトリ内でビルドします。
```
docker-compose up -d
```

### アプリケーションのセットアップ＆起動
```
docker-compose exec app bash
bundle install

memcached -u memcache -d
rackup -o 0.0.0.0
```

### データのインポート
sinatra/.docker/mysql/data に dump.sql を配置してから以下を打ちます。
```
docker-compose exec db bash -c 'mysql < dump.sql'
```
(インポートには時間がかかります。MBP(15インチ, 2017)では5分ぐらいかかりました)

DBのdumpデータはgoogle driveにあります。重いです。
https://drive.google.com/open?id=1iRKgcSl6PDpSStea0qxFZqjwSLY7PHzr



## ソフトウェア事項

高速化対象のソフトウェアとして[Sinatra](http://sinatrarb.com/)で作られた簡易なアプリケーションを用います。

プログラムの詳しい起動方法は、 /etc/systemd/system/isu-ruby.service を参照してください。

エラーなどの出力については、

```
$ sudo journalctl -f -u isu-ruby
```

などで見ることができます。また、unicornの再起動は、

```
$ sudo systemctl restart isu-ruby

# エラーが発生する場合、下記を一度実行する
$ sudo systemctl daemon-reload
```

などですることができます。サーバーの構築にはansibleが使われています。（構築時のバージョンは2.6.4）
brewが使用可能なMacPCなら最新バージョンを `brew install ansible` でinstallできます。

### MySQL

3306番ポートでMySQLが起動しています。初期状態では以下のユーザが設定されています。

  * ユーザ名: `root`, パスワードなし

### memcached

11211番ポートでmemcachedが起動しています。


## スコアについて

基本スコアは以下のルールで算出されます。

```
成功レスポンス数(GET) x 1 + 成功レスポンス数(POST) x 2 + 成功レスポンス数(画像投稿) x 5 - (サーバエラー(error)レスポンス数 x 10 + リクエスト失敗(exception)数 x 20 + 遅延POSTレスポンス数 x 100)
```

#### 減点対象

以下の事項に抵触すると減点対象となります。

  * 存在するべきファイルへのアクセスが失敗する
  * リクエスト失敗（通信エラー等）が発生する
  * サーバエラー(Status 5xx)・クライアントエラー(Status 4xx)をアプリケーションが返す
  * 他、計測ツールのチェッカが検出したケース

#### 注意事項

  * リダイレクトはリダイレクト先が正しいレスポンスを返せた場合に、1回レスポンスが成功したと判断します
  * POSTの失敗は大幅な減点対象です

### 制約事項

以下の事項に抵触すると点数が無効となります。

  * GET /initialize へのレスポンスが10秒以内に終わらない
  * 存在するべきDOM要素がレスポンスHTMLに存在しない

## 当日サポートについて

スタッフは当日いろいろ動き回っております。暇そうにしているスタッフを見つけて、順序を守ってお聞きください。スタッフの数には限りがございます！

ルールについてや、基本的なトラブルの質問にはお答えできますが、計測ツールおよびアプリケーションに関する質問には原則として回答しません！

何卒宜しくお願いします！
